<!DOCTYPE html>
<html>

<head>

    <link rel="stylesheet" href="https://atlas.microsoft.com/sdk/javascript/mapcontrol/2/atlas.min.css" type="text/css">
    <script src="https://atlas.microsoft.com/sdk/javascript/mapcontrol/2/atlas.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    <style>
        html,
        body {
            margin: 0;
        }

        #myMap {
            height: 100vh;
            width: 100vw;
        }
    </style>

</head>

<body>
    <div id="myMap"></div>
</body>

<script type="text/javascript">
    var map = new atlas.Map('myMap', {
        language: 'en-US',
        authOptions: {
            authType: 'subscriptionKey',
            subscriptionKey: 'c2X13dU6Bqf3LZM-hYKPubrU1wEWXH62Yrt634NXkWc'
        }
    });

    //Wait until the map resources are ready.
    map.events.add('ready', function () {

        data = []

        $.ajax({
            url: "http://104.42.153.193:3000/load",
            type: "POST",
            data: data,
            contentType: 'application/json',
            success: function (result) {
                var locations = result.locations
                var hashMap = new Map()

                for (var i = 0; i < locations.length; i++) {
                    //Create a HTML marker and add it to the map.

                    var options = {
                        color: 'red',
                        position: [locations[i].loc.lng, locations[i].loc.lat],
                        //instead of popup we will have a page with all the necessary statistics
                        popup: new atlas.Popup({
                            content: `<div style="padding:10px">${locations[i].name}</div>`,
                            pixelOffset: [0, -30]
                        })
                    };

                    var marker = new atlas.HtmlMarker(options);

                    console.log(options.position)

                    var string1 = JSON.stringify(options.position[0])
                    var string2 = JSON.stringify(options.position[1])
                    var loc = JSON.stringify(locations[i])

                    console.log(loc)


                    hashMap.set(string1 + string2, JSON.stringify(locations[i]))


                    console.log(i)

                    map.markers.add(marker);

                    //Add a click event to toggle the popup.
                    map.events.add('click', marker, (event) => {
                        // // marker.togglePopup();
                        var pos = event.target.options.position
                        console.log(pos)
                        var string1 = JSON.stringify(pos[0])
                        var string2 = JSON.stringify(pos[1])
                        console.log(hashMap.get(string1 + string2))
                        // // var data = hashMap.get(pos)
                        // console.log(hashMap)
                        // // console.log(data)
                    });
                }
            }
        });

    });
</script>

</html>